<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>AJAX Comments: ajax-comments/ajax-comments.php Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.4 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li class="current"><a href="files.html"><span>Files</span></a></li>
  </ul>
</div>
<h1>ajax-comments/ajax-comments.php</h1><a href="ajax-comments_8php.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?php
<a name="l00002"></a>00002 
<a name="l00017"></a>00017 define('AJAX_COMMENTS_PATH', dirname(__FILE__));
<a name="l00018"></a>00018 define('AJAX_COMMENTS_URL', get_settings('siteurl') .<span class="charliteral">'/'</span>. str_replace(str_replace(<span class="charliteral">'\\'</span>, <span class="charliteral">'/'</span>, ABSPATH), '', str_replace(<span class="charliteral">'\\'</span>, <span class="charliteral">'/'</span>, dirname(__FILE__))));
<a name="l00019"></a>00019 
<a name="l00020"></a>00020 <span class="comment">// Register hooks with WordPress core</span>
<a name="l00021"></a>00021 add_action('wp', '<a class="code" href="ajax-comments_8php.html#798125de48b911da6c8370a6b3946503" title="Implementation of wp action.">ajax_comments_wp</a>'); <span class="comment">// Executes after the query has been parsed and post(s) loaded, but before any template execution, inside the main WordPress function wp. Useful if you need to have access to post data but can't use templates for output. Action function argument: an array with a reference to the global $wp object.</span>
<a name="l00022"></a>00022 add_action('wp_head', '<a class="code" href="ajax-comments_8php.html#c42598ed32585d12b56581a1d60bd066" title="Implementation of admin_head action.">ajax_comments_wp_head</a>'); <span class="comment">// Runs when the template calls the wp_head function. This hook is generally placed near the top of a page template between &lt;head&gt; and &lt;/head&gt;. This hook does not take any parameters.</span>
<a name="l00023"></a>00023 add_filter('comments_template', '<a class="code" href="ajax-comments_8php.html#a138ccf22e3c71da27faec470496cf53" title="Implemenation of comments_template filter.">ajax_comments_comments_template</a>');
<a name="l00024"></a>00024 add_action('admin_menu', '<a class="code" href="ajax-comments_8php.html#a88fdaa6a4344e8cbc88896bc730aa10" title="Implementation of admin_menu action.">ajax_comments_admin_menu</a>'); <span class="comment">// Runs after the basic admin panel menu structure is in place.</span>
<a name="l00025"></a>00025 <span class="keywordflow">if</span> (function_exists('<a class="code" href="ajax-comments-post_8php.html#c4b7b30d103911e6a4e76e801e2c1884" title="Implementation of wp_redirect filter.">ajax_comments_wp_redirect</a>')) {
<a name="l00026"></a>00026   add_filter('wp_redirect', '<a class="code" href="ajax-comments-post_8php.html#c4b7b30d103911e6a4e76e801e2c1884" title="Implementation of wp_redirect filter.">ajax_comments_wp_redirect</a>'); <span class="comment">// Applied to a redirect URL by the default wp_redirect function. Filter function arguments: URL, HTTP status code.</span>
<a name="l00027"></a>00027 }
<a name="l00028"></a>00028 
<a name="l00033"></a>00033 function <a class="code" href="ajax-comments_8php.html#798125de48b911da6c8370a6b3946503" title="Implementation of wp action.">ajax_comments_wp</a>() {
<a name="l00034"></a>00034   global $withcomments;
<a name="l00035"></a>00035 
<a name="l00036"></a>00036   <span class="keywordflow">if</span> (function_exists('wp_enqueue_script')) { <span class="comment">// 2.1 - when wp_enqueue_script() was implemented</span>
<a name="l00037"></a>00037     <span class="keywordflow">if</span> ( ! (is_single() || is_page() || $withcomments) )
<a name="l00038"></a>00038       <span class="keywordflow">return</span>;
<a name="l00039"></a>00039 
<a name="l00040"></a>00040     <a class="code" href="ajax-comments_8php.html#77e1c0e28132ecb153c79c94d8dad218" title="Include AJAX Comments JavaScript file.">ajax_comments_js</a>(); <span class="comment">// include .js</span>
<a name="l00041"></a>00041   }
<a name="l00042"></a>00042 }
<a name="l00043"></a>00043 
<a name="l00049"></a>00049 function <a class="code" href="ajax-comments_8php.html#c42598ed32585d12b56581a1d60bd066" title="Implementation of admin_head action.">ajax_comments_wp_head</a>() {
<a name="l00050"></a>00050   global $withcomments;
<a name="l00051"></a>00051 
<a name="l00052"></a>00052   <span class="keywordflow">if</span> (!(is_single() || is_page() || $withcomments))
<a name="l00053"></a>00053     <span class="keywordflow">return</span>;
<a name="l00054"></a>00054 
<a name="l00055"></a>00055   <a class="code" href="ajax-comments_8php.html#77e1c0e28132ecb153c79c94d8dad218" title="Include AJAX Comments JavaScript file.">ajax_comments_js</a>();
<a name="l00056"></a>00056 }
<a name="l00057"></a>00057 
<a name="l00061"></a>00061 function <a class="code" href="ajax-comments_8php.html#77e1c0e28132ecb153c79c94d8dad218" title="Include AJAX Comments JavaScript file.">ajax_comments_js</a>() {
<a name="l00062"></a>00062   global $wp_version, $withcomments;
<a name="l00063"></a>00063   $version = (int) sprintf('%0-5s', str_replace(<span class="charliteral">'.'</span>, '', $wp_version)); <span class="comment">// format as integer for less-than/greater-than comparison</span>
<a name="l00064"></a>00064 
<a name="l00065"></a>00065   <span class="comment">// only include once per page</span>
<a name="l00066"></a>00066   <span class="keyword">static</span> $included;
<a name="l00067"></a>00067   <span class="keywordflow">if</span> ($included) {
<a name="l00068"></a>00068     <span class="keywordflow">return</span>;
<a name="l00069"></a>00069   } <span class="keywordflow">else</span> {
<a name="l00070"></a>00070     $included = TRUE;
<a name="l00071"></a>00071   }
<a name="l00072"></a>00072 
<a name="l00073"></a>00073   <span class="keywordflow">if</span> ($version &gt;= 22000) { <span class="comment">// WP 2.2 - when jQuery was implemented</span>
<a name="l00074"></a>00074     <span class="keywordflow">return</span> wp_enqueue_script('ajax_comments', AJAX_COMMENTS_URL .'/ajax-comments.js.php', array('jquery', 'jquery-form'));
<a name="l00075"></a>00075   } <span class="keywordflow">else</span> {
<a name="l00076"></a>00076     <span class="comment">// use the jQuery packaged with AJAX Comments</span>
<a name="l00077"></a>00077     print '&lt;script type=<span class="stringliteral">"text/javascript"</span> src=<span class="stringliteral">"'. AJAX_COMMENTS_URL .'/jquery/jquery.js"</span>&gt;&lt;/script&gt;'.<span class="stringliteral">"\n"</span>;
<a name="l00078"></a>00078     print '&lt;script type=<span class="stringliteral">"text/javascript"</span> src=<span class="stringliteral">"'. AJAX_COMMENTS_URL .'/jquery/jquery.form.js"</span>&gt;&lt;/script&gt;'.<span class="stringliteral">"\n"</span>;
<a name="l00079"></a>00079   }
<a name="l00080"></a>00080 
<a name="l00081"></a>00081   <span class="keywordflow">if</span> ($version &gt;= 21000) { <span class="comment">// 2.1 - when wp_enqueue_script() was implemented</span>
<a name="l00082"></a>00082     <span class="keywordflow">return</span> wp_enqueue_script('ajax_comments', AJAX_COMMENTS_URL .'/ajax-comments.js.php');
<a name="l00083"></a>00083   } <span class="keywordflow">else</span> {
<a name="l00084"></a>00084     print '&lt;script type=<span class="stringliteral">"text/javascript"</span> src=<span class="stringliteral">"'. AJAX_COMMENTS_URL .'/ajax-comments.js.php"</span>&gt;&lt;/script&gt;'.<span class="stringliteral">"\n"</span>;
<a name="l00085"></a>00085   }
<a name="l00086"></a>00086 }
<a name="l00087"></a>00087 
<a name="l00092"></a>00092 function <a class="code" href="ajax-comments_8php.html#a138ccf22e3c71da27faec470496cf53" title="Implemenation of comments_template filter.">ajax_comments_comments_template</a>($include) {
<a name="l00093"></a>00093   <span class="keywordflow">return</span> AJAX_COMMENTS_PATH .'/ajax-comments-<span class="keyword">template</span>.php';
<a name="l00094"></a>00094 }
<a name="l00095"></a>00095 
<a name="l00099"></a>00099 function <a class="code" href="ajax-comments_8php.html#a88fdaa6a4344e8cbc88896bc730aa10" title="Implementation of admin_menu action.">ajax_comments_admin_menu</a>() {
<a name="l00100"></a>00100   $hook = add_submenu_page('options-general.php', __('AJAX Comments Settings'), __('AJAX Comments'), 'manage_options', 'ajax_comments', '<a class="code" href="ajax-comments_8php.html#7629014cb3b6662566c7ef61c12cdce7" title="Submenu Page callback for Options &amp;gt; AJAX Comments.">ajax_comments_settings</a>');
<a name="l00101"></a>00101 }
<a name="l00102"></a>00102 
<a name="l00107"></a>00107 function <a class="code" href="ajax-comments_8php.html#7629014cb3b6662566c7ef61c12cdce7" title="Submenu Page callback for Options &amp;gt; AJAX Comments.">ajax_comments_settings</a>() {
<a name="l00108"></a>00108   global $plugin_page;
<a name="l00109"></a>00109 
<a name="l00110"></a>00110   <span class="comment">// Read in existing option values from database</span>
<a name="l00111"></a>00111   $options = get_option('ajax_comments_options');
<a name="l00112"></a>00112 
<a name="l00113"></a>00113   <span class="comment">// See if the user has posted some information</span>
<a name="l00114"></a>00114   <span class="keywordflow">if</span> (isset($_POST['submit'])) {
<a name="l00115"></a>00115     $options['performance'] = $_POST['performance'];
<a name="l00116"></a>00116 
<a name="l00117"></a>00117     <span class="comment">// Save the posted value in the database</span>
<a name="l00118"></a>00118     update_option('ajax_comments_options', $options);
<a name="l00119"></a>00119 
<a name="l00120"></a>00120     <span class="comment">// Notify user their settings were saved</span>
<a name="l00121"></a>00121     $output .= '&lt;div <span class="keyword">class</span>=<span class="stringliteral">"updated"</span>&gt;&lt;p&gt;&lt;strong&gt;'. __('Settings saved.') .'&lt;/strong&gt;&lt;/p&gt;&lt;/div&gt;';
<a name="l00122"></a>00122   }
<a name="l00123"></a>00123 
<a name="l00124"></a>00124   $output .= '&lt;div <span class="keyword">class</span>=<span class="stringliteral">"wrap"</span>&gt;'.<span class="stringliteral">"\n"</span>;
<a name="l00125"></a>00125   $output .= '  &lt;h2&gt;'. __('AJAX Comments Settings') .'&lt;/h2&gt;'.<span class="stringliteral">"\n"</span>;
<a name="l00126"></a>00126   $output .= '  &lt;form method=<span class="stringliteral">"post"</span> action=<span class="stringliteral">"options-general.php?page='. $plugin_page .'"</span>&gt;'.<span class="stringliteral">"\n"</span>;
<a name="l00127"></a>00127   $output .= '    &lt;h3&gt;'. __('Performance options') .':&lt;/h3&gt;'.<span class="stringliteral">"\n"</span>;
<a name="l00128"></a>00128   $output .= '    &lt;p&gt;'. __('There are a couple ways that AJAX Comments can work depending on the type of theme you have.') .'&lt;/p&gt;'.<span class="stringliteral">"\n"</span>;
<a name="l00129"></a>00129   $output .= '    &lt;p&gt;&lt;label&gt;'.<span class="stringliteral">"\n"</span>;
<a name="l00130"></a>00130   $output .= '      &lt;input name=<span class="stringliteral">"performance"</span> type=<span class="stringliteral">"radio"</span> value=<span class="stringliteral">"flexible"</span>'. (!isset($options['performance']) || $options['performance'] == 'flexible'? ' checked=<span class="stringliteral">"checked"</span>' : '') .' /&gt;'.<span class="stringliteral">"\n"</span>;
<a name="l00131"></a>00131   $output .= '      &lt;strong&gt;'. __('Flexible approach') .'&lt;/strong&gt;; '. __('replace entire comments.php <span class="keyword">template</span> markup with each <span class="keyword">new</span> comment.') .'&lt;/label&gt;&lt;br /&gt;'.<span class="stringliteral">"\n"</span>;
<a name="l00132"></a>00132   $output .= '      &lt;ul&gt;'.<span class="stringliteral">"\n"</span>;
<a name="l00133"></a>00133   $output .= '        &lt;li&gt;'. __('compatible; works with 99.9% of all themes.') .'&lt;/li&gt;'.<span class="stringliteral">"\n"</span>;
<a name="l00134"></a>00134   $output .= '        &lt;li&gt;'. __('flexible; supports unique <span class="keyword">template</span> customizations.') .'&lt;/li&gt;'.<span class="stringliteral">"\n"</span>;
<a name="l00135"></a>00135   $output .= '        &lt;li&gt;'. __('more bandwidth; more to download per-user, and connections to the server remain open longer depending on the post.') .'&lt;/li&gt;'.<span class="stringliteral">"\n"</span>;
<a name="l00136"></a>00136   $output .= '        &lt;li&gt;'. __('slower; may time out with too many comments on some servers.') .'&lt;/li&gt;'.<span class="stringliteral">"\n"</span>;
<a name="l00137"></a>00137   $output .= '      &lt;/ul&gt;'.<span class="stringliteral">"\n"</span>;
<a name="l00138"></a>00138   $output .= '    &lt;/p&gt;'.<span class="stringliteral">"\n"</span>;
<a name="l00139"></a>00139   $output .= '    &lt;p&gt;&lt;label&gt;'.<span class="stringliteral">"\n"</span>;
<a name="l00140"></a>00140   $output .= '      &lt;input name=<span class="stringliteral">"performance"</span> type=<span class="stringliteral">"radio"</span> value=<span class="stringliteral">"conventional"</span>'. ($options['performance'] == 'conventional'? ' checked=<span class="stringliteral">"checked"</span>' : '') .' /&gt;'.<span class="stringliteral">"\n"</span>;
<a name="l00141"></a>00141   $output .= '      &lt;strong&gt;'. __('Conventional approach') .'&lt;/strong&gt;; '. __('append <span class="keyword">new</span> comments only.') .'&lt;/label&gt;&lt;br /&gt;'.<span class="stringliteral">"\n"</span>;
<a name="l00142"></a>00142   $output .= '      &lt;ul&gt;'.<span class="stringliteral">"\n"</span>;
<a name="l00143"></a>00143   $output .= '        &lt;li&gt;'. __('conventional; your theme must follow a few basic conventions originally established by Michael Kubrick in the Default blue WordPress theme') .':&lt;br /&gt;&lt;br /&gt;'.<span class="stringliteral">"\n"</span>;
<a name="l00144"></a>00144   $output .= '          &lt;ol&gt;'.<span class="stringliteral">"\n"</span>;
<a name="l00145"></a>00145   $output .= '            &lt;li&gt;'. __('Comment counter has') .' &lt;code style=<span class="stringliteral">"background:#eee; border-bottom:1px dotted #999"</span>&gt;<span class="keywordtype">id</span>=<span class="stringliteral">"comments"</span>&lt;/code&gt;.&lt;/li&gt;'.<span class="stringliteral">"\n"</span>;
<a name="l00146"></a>00146   $output .= '            &lt;li&gt;'. __('OL or UL elements have') .' &lt;code style=<span class="stringliteral">"background:#eee; border-bottom:1px dotted #999"</span>&gt;<span class="keyword">class</span>=<span class="stringliteral">"commentlist"</span>&lt;/code&gt;.&lt;/li&gt;'.<span class="stringliteral">"\n"</span>;
<a name="l00147"></a>00147   $output .= '            &lt;li&gt;'. __('LI elements have') .' &lt;code style=<span class="stringliteral">"background:#eee; border-bottom:1px dotted #999"</span>&gt;<span class="keywordtype">id</span>=<span class="stringliteral">"comment-&amp;lt;comment_id&amp;gt;"</span>&lt;/code&gt;.&lt;/li&gt;'.<span class="stringliteral">"\n"</span>;
<a name="l00148"></a>00148   $output .= '          &lt;/ol&gt;'.<span class="stringliteral">"\n"</span>;
<a name="l00149"></a>00149   $output .= '        &lt;/li&gt;'.<span class="stringliteral">"\n"</span>;
<a name="l00150"></a>00150   $output .= '        &lt;li&gt;'. __('precise; only the comment counter will be updated.') .'&lt;/li&gt;'.<span class="stringliteral">"\n"</span>;
<a name="l00151"></a>00151   $output .= '        &lt;li&gt;'. __('less bandwidth; minimal data transfer, and connections remain brief regardless of the post.') .'&lt;/li&gt;'.<span class="stringliteral">"\n"</span>;
<a name="l00152"></a>00152   $output .= '      &lt;/ul&gt;'.<span class="stringliteral">"\n"</span>;
<a name="l00153"></a>00153   $output .= '      &lt;/span&gt;'.<span class="stringliteral">"\n"</span>;
<a name="l00154"></a>00154   $output .= '    &lt;/p&gt;'.<span class="stringliteral">"\n\n"</span>;
<a name="l00155"></a>00155   $output .= '    &lt;p <span class="keyword">class</span>=<span class="stringliteral">"submit"</span>&gt;'.<span class="stringliteral">"\n"</span>;
<a name="l00156"></a>00156   $output .= '      &lt;input type=<span class="stringliteral">"submit"</span> name=<span class="stringliteral">"submit"</span> value=<span class="stringliteral">"'. __('Update Settings') .'&amp;raquo;"</span> /&gt;'.<span class="stringliteral">"\n"</span>;
<a name="l00157"></a>00157   $output .= '    &lt;/p&gt;'.<span class="stringliteral">"\n"</span>;
<a name="l00158"></a>00158   $output .= '  &lt;/form&gt;'.<span class="stringliteral">"\n"</span>;
<a name="l00159"></a>00159   $output .= '&lt;/div&gt;'.<span class="stringliteral">"\n"</span>;
<a name="l00160"></a>00160 
<a name="l00161"></a>00161   print $output;
<a name="l00162"></a>00162 }
</pre></div><hr size="1"><address style="text-align: right;"><small>Generated on Sat Apr 19 17:50:17 2008 for AJAX Comments by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.4 </small></address>
</body>
</html>
